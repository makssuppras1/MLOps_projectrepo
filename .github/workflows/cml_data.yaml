name: "CML - Data Validation"

on:
  push:
    branches: [master, main]
    paths:
      - "data.dvc"
      - "data/**"
  pull_request:
    branches: [master, main]
    paths:
      - "data.dvc"
      - "data/**"

jobs:
  data-validation:
    name: "Validate Data Changes"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          uv sync --dev --locked

      - name: Setup DVC (optional)
        uses: iterative/setup-dvc@v2
        continue-on-error: true

      - name: Pull data with DVC
        id: dvc-pull
        run: |
          if ! dvc pull; then
            echo "âŒ DVC pull failed. This may indicate data accessibility issues."
            echo "Check that:"
            echo "  1. GCS bucket is accessible: gs://mlops_project_data_bucket1/"
            echo "  2. Service account has Storage Object Viewer permissions"
            echo "  3. DVC remote is configured: dvc remote list"
            exit 1
          fi
          echo "âœ… DVC pull succeeded"

      - name: Compute dataset statistics
        id: stats
        continue-on-error: true
        run: |
          uv run python src/pname/data_stats.py --processed-dir data/processed > stats_output.txt 2>&1 || echo "Statistics computation completed with warnings"
          cat stats_output.txt

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Comment PR report
        if: github.event_name == 'pull_request'
        continue-on-error: true
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸ“Š Data Validation Report" > report.md
          echo "" >> report.md
          if [ -f stats_output.txt ]; then
            cat stats_output.txt >> report.md
          else
            echo "âš ï¸  Statistics computation did not produce output" >> report.md
          fi
          cml comment create report.md --pr ${{ github.event.pull_request.number }} || echo "CML comment failed (non-blocking)"
