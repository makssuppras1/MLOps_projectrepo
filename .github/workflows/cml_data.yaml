name: "CML - Data Validation"

on:
  push:
    branches: [master, main]
    paths:
      - "data.dvc"
      - "data/**"
  pull_request:
    branches: [master, main]
    paths:
      - "data.dvc"
      - "data/**"

jobs:
  data-validation:
    name: "Validate Data Changes"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          uv sync --dev --locked

      - name: Setup DVC (optional)
        uses: iterative/setup-dvc@v2
        continue-on-error: true

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}
        continue-on-error: true

      - name: Pull data with DVC
        id: dvc-pull
        continue-on-error: true
        run: |
          if ! dvc pull; then
            echo "âš ï¸  DVC pull failed. This may indicate data accessibility issues."
            echo "Check that:"
            echo "  1. GCS bucket is accessible: gs://mlops_project_data_bucket1/"
            echo "  2. Service account has Storage Object Viewer permissions"
            echo "  3. DVC remote is configured: dvc remote list"
            echo "  4. GCP_SA_KEY secret is configured in GitHub repository settings"
            echo ""
            echo "Continuing without DVC data pull - using data already in repository if available."
            echo "dvc_pull_success=false" >> $GITHUB_OUTPUT
          else
            echo "âœ… DVC pull succeeded"
            echo "dvc_pull_success=true" >> $GITHUB_OUTPUT
          fi

      - name: Compute dataset statistics
        id: stats
        continue-on-error: true
        run: |
          # Check if processed data exists (either from DVC pull or already in repo)
          if [ ! -d "data/processed" ] || [ -z "$(ls -A data/processed 2>/dev/null)" ]; then
            echo "âš ï¸  No processed data found. Skipping statistics computation."
            echo "Data may need to be:"
            echo "  1. Pulled via DVC (requires GCP authentication)"
            echo "  2. Preprocessed locally: uv run invoke preprocess-data"
            echo "Statistics computation skipped" > stats_output.txt
          else
            uv run python src/pname/data_stats.py --processed-dir data/processed > stats_output.txt 2>&1 || echo "Statistics computation completed with warnings"
          fi
          cat stats_output.txt

      - name: Setup CML
        uses: iterative/setup-cml@v2

      - name: Comment PR report
        if: github.event_name == 'pull_request'
        continue-on-error: true
        env:
          REPO_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "## ðŸ“Š Data Validation Report" > report.md
          echo "" >> report.md
          if [ -f stats_output.txt ]; then
            cat stats_output.txt >> report.md
          else
            echo "âš ï¸  Statistics computation did not produce output" >> report.md
          fi
          cml comment create report.md --pr ${{ github.event.pull_request.number }} || echo "CML comment failed (non-blocking)"
